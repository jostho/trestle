---
# tasks file for client
- name: setup local directory
  file:
    path: "{{ item }}"
    state: directory
    mode: 0770
  with_items:
    - "{{ tmp_location }}"
    - ~/src/k8s
    - ~/.kube
    - ~/.local/share/bash-completion/completions

- name: update profile
  blockinfile:
    path: ~/.profile
    block: |
        export KUBECONFIG=~/.kube/k3s.yaml

- name: download kubectl
  become: yes
  get_url:
    url: https://dl.k8s.io/release/{{ version.kubectl }}/bin/linux/amd64/kubectl
    dest: /usr/local/bin/kubectl
    owner: root
    group: root
    mode: 0755
    timeout: 60

- name: download helm archive
  get_url:
    url: https://get.helm.sh/helm-{{ version.helm }}-linux-amd64.tar.gz
    dest: "{{ tmp_location }}"
    timeout: 60

- name: extract helm
  become: yes
  unarchive:
    src: "{{ tmp_location }}/helm-{{ version.helm }}-linux-amd64.tar.gz"
    dest: /usr/local/bin
    owner: root
    group: root
    remote_src: yes
    extra_opts:
      - --strip-components=1
      - linux-amd64/helm

- name: download kubeconform archive
  get_url:
    url: https://github.com/yannh/kubeconform/releases/download/{{ version.kubeconform }}/kubeconform-linux-amd64.tar.gz
    dest: "{{ tmp_location }}"
    timeout: 60

- name: extract kubeconform
  become: yes
  unarchive:
    src: "{{ tmp_location }}/kubeconform-linux-amd64.tar.gz"
    dest: /usr/local/bin
    owner: root
    group: root
    remote_src: yes
    extra_opts:
      - kubeconform

- name: run kubectl completion
  shell: kubectl completion bash > ~/.local/share/bash-completion/completions/kubectl
  args:
    creates: ~/.local/share/bash-completion/completions/kubectl

- name: get kubeconfig to local
  fetch:
    src: /etc/rancher/k3s/k3s.yaml
    dest: /tmp/
    flat: yes
  delegate_to: "{{ groups['master'][0] }}"

- name: push kubeconfig
  copy:
    src: /tmp/k3s.yaml
    dest: ~/.kube/k3s.yaml
    mode: 0600

- name: point kubeconfig server to master
  replace:
    path: ~/.kube/k3s.yaml
    regexp: "https://127.0.0.1:6443"
    replace: "https://{{ groups['master'][0] }}:6443"

- name: delete local kubeconfig
  file:
    path: /tmp/k3s.yaml
    state: absent
  delegate_to: localhost

- name: install packages
  become: yes
  package: name={{ item }} state=present
  with_items:
    - nfs-kernel-server
    - haproxy

- name: setup system directory
  become: yes
  file:
    path: "{{ item }}"
    state: directory
    mode: 0755
  with_items:
    - /etc/exports.d
    - "{{ nfs_location }}"

- name: push exports
  become: yes
  template:
    src: trestle.exports.j2
    dest: /etc/exports.d/trestle.exports
    mode: 0644
  notify: start nfs service

- name: push haproxy.cfg
  become: yes
  template:
    src: haproxy.cfg.j2
    dest: /etc/haproxy/haproxy.cfg
    mode: 0644
  notify: start haproxy service
