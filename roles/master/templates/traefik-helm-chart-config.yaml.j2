---
apiVersion: helm.cattle.io/v1
kind: HelmChartConfig
metadata:
  name: traefik
  namespace: kube-system
spec:
  valuesContent: |-
    logs:
      access:
        # enable access logs
        enabled: true
        fields:
          # keep headers
          headers:
            defaultmode: keep
    # turn off global args
    globalArguments:
      - "--global.checknewversion=false"
      - "--global.sendanonymoususage=false"
    # enable XFF
    additionalArguments:
      - "--entrypoints.web.forwardedheaders.insecure"
    service:
      spec:
        # pick up first ip from metallb address range
        loadBalancerIP: {{ metallb.address_range.split('-')[0] }}
        # preserve client ip
        externalTrafficPolicy: Local
    ports:
      traefik:
        # expose the traefik port
        expose: true
